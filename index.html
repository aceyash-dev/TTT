<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ace Horizon: Tic-Tac-Toe</title>
    <style>
        :root {
            /* Theme Variables */
            --bg-dark: #050510;
            --primary: #00f3ff;  /* Cyan */
            --secondary: #7000ff; /* Purple */
            --accent: #ff0055;   /* Red */
            --gold: #ffd700;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(0, 243, 255, 0.2);
            --text-main: #ffffff;
            --font-tech: 'Courier New', monospace;
            --font-ui: 'Segoe UI', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- UI Containers --- */
        .app-container {
            width: 100%; max-width: 420px;
            display: flex; flex-direction: column; align-items: center;
            gap: 15px; padding: 20px; z-index: 2; flex-grow: 1;
        }

        /* --- HUD --- */
        .hud-panel {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); padding: 10px 20px; border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }

        .user-section { cursor: pointer; transition: 0.3s; }
        .user-section:active { opacity: 0.6; }
        .user-name { font-weight: bold; font-size: 1.1rem; letter-spacing: 1px; }
        .user-rank { font-size: 0.7rem; color: var(--primary); font-family: var(--font-tech); }

        .coin-chip {
            border: 1px solid var(--gold); color: var(--gold);
            padding: 5px 12px; border-radius: 20px; font-weight: bold;
            font-family: var(--font-tech); display: flex; gap: 5px; align-items: center;
            background: rgba(0,0,0,0.5);
        }

        /* --- Game Board --- */
        .board-container {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .game-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        .cell {
            width: 80px; height: 80px;
            background: rgba(255,255,255,0.04); border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; cursor: pointer; transition: 0.2s;
        }
        .cell:active { transform: scale(0.95); }
        .cell.taken { cursor: default; }
        
        /* Marks */
        .x-mark { color: var(--accent); text-shadow: 0 0 15px var(--accent); animation: popIn 0.3s forwards; }
        .o-mark { color: var(--primary); text-shadow: 0 0 15px var(--primary); animation: popIn 0.3s forwards; }
        .cell.win { background: rgba(255,255,255,0.15); box-shadow: inset 0 0 20px var(--primary); }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

        /* --- Controls --- */
        .controls { width: 100%; display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
        
        .btn {
            background: transparent; border: 1px solid var(--glass-border); color: white;
            padding: 10px; border-radius: 8px; font-family: var(--font-tech); cursor: pointer;
            flex: 1; text-align: center; transition: 0.3s; font-size: 0.8rem;
        }
        .btn:hover { background: var(--primary); color: black; box-shadow: 0 0 15px var(--primary); }
        .btn-restart { border-color: var(--accent); }
        .btn-restart:hover { background: var(--accent); box-shadow: 0 0 15px var(--accent); }

        select { background: #000; color: white; border: 1px solid #333; padding: 10px; border-radius: 8px; outline: none; }

        /* --- MODALS (Profile, Login, Shop) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: #0f0f1a; width: 90%; max-width: 350px;
            border: 1px solid var(--primary); border-radius: 16px; padding: 20px;
            position: relative; box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.open .modal-card { transform: scale(1); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-title { margin: 0; color: var(--primary); font-family: var(--font-tech); }
        .close-btn { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }

        /* Profile Specifics */
        .profile-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .p-stat { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; }
        .p-stat h4 { margin: 0; color: #888; font-size: 0.7rem; }
        .p-stat span { font-size: 1.2rem; font-weight: bold; }
        .achievements-list { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 20px; }
        .ach-badge { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; filter: grayscale(1); }
        .ach-badge.unlocked { background: var(--gold); color: black; filter: grayscale(0); box-shadow: 0 0 10px var(--gold); }

        /* Login Captcha */
        .captcha-box { 
            background: #fff; color: #000; padding: 15px; border-radius: 4px; 
            display: flex; align-items: center; gap: 10px; margin: 20px 0;
            font-family: Arial, sans-serif;
        }
        .checkbox { width: 24px; height: 24px; border: 2px solid #ccc; cursor: pointer; }
        .checkbox.checked { background: #4caf50; border-color: #4caf50; position: relative; }
        .checkbox.checked::after { content: '✔'; color: white; position: absolute; left: 5px; top: 1px; }

        /* --- Ads Area --- */
        .ad-banner {
            width: 100%; height: 60px; background: #111;
            display: flex; justify-content: center; align-items: center;
            border-top: 1px solid #333; font-size: 0.7rem; color: #444;
            margin-top: auto;
        }

        /* --- Toast --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #111; border-left: 4px solid var(--primary); color: white;
            padding: 12px 20px; border-radius: 4px; z-index: 200;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; top: 30px; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="auth-modal">
        <div class="modal-card">
            <h2 class="modal-title">SECURITY GATEWAY</h2>
            <p style="font-size:0.8rem; color:#888;">Identity verification required.</p>
            
            <div class="captcha-box" onclick="toggleCaptcha(this)">
                <div class="checkbox" id="captcha-check"></div>
                <span>I am not a robot</span>
                <img src="https://www.gstatic.com/recaptcha/api2/logo_48.png" style="width:24px; margin-left:auto; opacity:0.5;">
            </div>

            <button class="btn" id="login-btn" style="width:100%; opacity:0.5; pointer-events:none;" onclick="completeLogin()">ENTER SYSTEM</button>
        </div>
    </div>

    <div class="app-container">
        
        <div class="hud-panel">
            <div class="user-section" onclick="openProfile()">
                <div class="user-name" id="hud-username">Player</div>
                <div class="user-rank" id="hud-rank">LEVEL 1</div>
            </div>
            <div class="coin-chip">
                <span>◆</span> <span id="hud-coins">0</span>
            </div>
        </div>

        <div style="font-family:var(--font-tech); font-size:0.8rem; color:#666; height:20px;" id="status-text">
            SYSTEM READY
        </div>

        <div class="board-container">
            <div class="game-grid" id="game-board">
                </div>
        </div>

        <div class="controls">
            <select id="difficulty">
                <option value="easy">EASY (10c)</option>
                <option value="medium" selected>MEDIUM (25c)</option>
                <option value="hard">IMPOSSIBLE (50c)</option>
            </select>
            <button class="btn" onclick="toggleShop()">SHOP</button>
            <button class="btn btn-restart" onclick="restartGame()">RESTART</button>
        </div>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">AGENT PROFILE</h3>
                <button class="close-btn" onclick="closeProfile()">&times;</button>
            </div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:60px; height:60px; background:var(--primary); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; color:black; font-weight:bold; font-size:1.5rem;" id="p-avatar">P</div>
                <h2 id="p-name" style="margin:0;">Player</h2>
                <small id="p-id" style="color:#666;">ID: #8392-A</small>
            </div>

            <div class="profile-stat-grid">
                <div class="p-stat"><h4>WINS</h4><span id="p-wins">0</span></div>
                <div class="p-stat"><h4>LOSSES</h4><span id="p-losses">0</span></div>
                <div class="p-stat"><h4>STREAK</h4><span id="p-streak">0</span></div>
                <div class="p-stat"><h4>COINS</h4><span id="p-coins">0</span></div>
            </div>

            <div style="margin-bottom:10px; font-size:0.8rem; color:#888;">ACHIEVEMENTS</div>
            <div class="achievements-list" id="p-achievements">
                </div>

            <button class="btn" style="width:100%; border-color:var(--gold); color:var(--gold);" onclick="shareProfile()">SHARE PROFILE</button>
        </div>
    </div>

    <div class="modal-overlay" id="shop-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">THEME SHOP</h3>
                <button class="close-btn" onclick="toggleShop()">&times;</button>
            </div>
            <div id="shop-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>
    </div>

    <div class="ad-banner" id="ad-slot">
        [ ADSENSE BANNER LOADING... ]
    </div>

    <div class="toast" id="toast">Message</div>

    <script>
        /**
         * ======================================
         * 1. STORAGE & SYNC SYSTEM
         * ======================================
         */
        const DB = {
            keys: {
                coins: 'user_coins',
                session: 'user_session',
                stats: 'user_stats',
                theme: 'user_theme',
                inv: 'user_inventory'
            },
            get: (key, def) => {
                const val = localStorage.getItem(key);
                try { return val ? JSON.parse(val) : def; } catch(e) { return val || def; }
            },
            set: (key, val) => {
                localStorage.setItem(key, typeof val === 'object' ? JSON.stringify(val) : val);
            }
        };

        // Default Data
        let User = {
            name: "Agent_01",
            id: "U-" + Math.floor(Math.random()*10000),
            coins: 0,
            stats: { wins: 0, losses: 0, streak: 0 },
            achievements: [],
            theme: 'default',
            inventory: ['default']
        };

        // --- SYNC ENGINE ---
        function syncData() {
            // Check session
            let session = DB.get(DB.keys.session, null);
            if(!session) {
                // If no session, wait for Login
                return false;
            } else {
                User.name = session.username || "Player";
                User.id = session.id || "Unknown";
            }

            // Sync Coins (Two-way)
            User.coins = parseInt(localStorage.getItem(DB.keys.coins)) || 0;
            
            // Sync Stats
            User.stats = DB.get(DB.keys.stats, { wins:0, losses:0, streak:0 });
            User.achievements = DB.get('user_achievements', []);
            User.theme = localStorage.getItem(DB.keys.theme) || 'default';
            User.inventory = DB.get(DB.keys.inv, ['default']);

            updateHUD();
            return true;
        }

        function saveGameData() {
            localStorage.setItem(DB.keys.coins, User.coins); // Direct save for AppDrawer
            DB.set(DB.keys.stats, User.stats);
            DB.set('user_achievements', User.achievements);
            DB.set(DB.keys.inv, User.inventory);
            localStorage.setItem(DB.keys.theme, User.theme);
            updateHUD();
        }

        // Listen for changes from AppDrawer
        window.addEventListener('storage', (e) => {
            if (e.key === DB.keys.coins || e.key === DB.keys.session) {
                syncData();
            }
        });
        
        // Polling fallback (every 2s) to ensure balance is correct
        setInterval(syncData, 2000);

        /**
         * ======================================
         * 2. UI & AUTH LOGIC
         * ======================================
         */
        const UI = {
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 3000);
            }
        };

        function checkAuth() {
            if(!syncData()) {
                document.getElementById('auth-modal').classList.add('open');
            } else {
                initGame();
            }
        }

        // Login Simulation
        function toggleCaptcha(el) {
            const check = el.querySelector('.checkbox');
            const btn = document.getElementById('login-btn');
            
            if(!check.classList.contains('checked')) {
                // Fake processing delay
                setTimeout(() => {
                    check.classList.add('checked');
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'all';
                }, 800);
            }
        }

        function completeLogin() {
            // Create a fake session
            DB.set(DB.keys.session, { username: User.name, id: User.id });
            document.getElementById('auth-modal').classList.remove('open');
            UI.toast("AUTHENTICATION SUCCESSFUL");
            initGame();
        }

        function updateHUD() {
            document.getElementById('hud-username').innerText = User.name;
            document.getElementById('hud-coins').innerText = User.coins;
            document.documentElement.style.setProperty('--primary', getThemeColor(User.theme));
        }

        // Ads Simulation
        function loadAds() {
            const banner = document.getElementById('ad-slot');
            setTimeout(() => {
                banner.innerHTML = `<span style="color:#00f3ff; cursor:pointer;" onclick="UI.toast('Ad Clicked (Simulated)')">⚡ POWER UP YOUR GAME - DOWNLOAD NOW ⚡</span>`;
            }, 1500);
        }

        /**
         * ======================================
         * 3. GAME ENGINE (Optimized)
         * ======================================
         */
        let board = Array(9).fill(null);
        let isPlayerTurn = true; // STRICT LOCK
        let isGameActive = true;
        
        const cells = [];
        const winPatterns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

        function initGame() {
            const grid = document.getElementById('game-board');
            grid.innerHTML = '';
            cells.length = 0;
            board.fill(null);
            isGameActive = true;
            isPlayerTurn = true;
            document.getElementById('status-text').innerText = "PLAYER TURN";

            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => handleInput(i));
                grid.appendChild(cell);
                cells.push(cell);
            }
            loadAds();
        }

        function handleInput(index) {
            // STRICT CHECK: If game over, not player turn, or cell taken -> STOP.
            if (!isGameActive || !isPlayerTurn || board[index] !== null) return;

            // Player Move
            placeMark(index, 'X');
            
            if (checkWin('X')) { endGame(true); return; }
            if (checkDraw()) { endGame(null); return; }

            // Switch to AI
            isPlayerTurn = false;
            document.getElementById('status-text').innerText = "AI COMPUTING...";

            // Delay for realism, then AI moves
            setTimeout(() => {
                if(!isGameActive) return; // Safety check
                aiTurn();
            }, 600);
        }

        function aiTurn() {
            const difficulty = document.getElementById('difficulty').value;
            let moveIndex = -1;

            if (difficulty === 'easy') moveIndex = getRandomMove();
            else if (difficulty === 'medium') moveIndex = Math.random() > 0.3 ? getBestMove(2) : getRandomMove();
            else moveIndex = getBestMove(100); // Impossible

            if (moveIndex !== -1) {
                placeMark(moveIndex, 'O');
                if (checkWin('O')) endGame(false);
                else if (checkDraw()) endGame(null);
                else {
                    isPlayerTurn = true; // Unlock for player
                    document.getElementById('status-text').innerText = "PLAYER TURN";
                }
            }
        }

        function placeMark(index, type) {
            board[index] = type;
            cells[index].innerHTML = type === 'X' ? 
                `<span class="x-mark">✕</span>` : `<span class="o-mark">◯</span>`;
            cells[index].classList.add('taken');
        }

        // --- AI LOGIC (Minimax) ---
        function getBestMove(depthLimit) {
            let bestScore = -Infinity;
            let move = -1;
            for(let i=0; i<9; i++) {
                if(board[i] === null) {
                    board[i] = 'O';
                    let score = minimax(board, 0, false, depthLimit);
                    board[i] = null;
                    if(score > bestScore) { bestScore = score; move = i; }
                }
            }
            return move;
        }

        function minimax(b, depth, isMax, limit) {
            if (checkWinStatic(b, 'O')) return 10 - depth;
            if (checkWinStatic(b, 'X')) return depth - 10;
            if (!b.includes(null)) return 0;
            if (depth >= limit) return 0;

            if (isMax) {
                let best = -Infinity;
                for(let i=0; i<9; i++) {
                    if(b[i] === null) {
                        b[i] = 'O';
                        best = Math.max(best, minimax(b, depth+1, false, limit));
                        b[i] = null;
                    }
                }
                return best;
            } else {
                let best = Infinity;
                for(let i=0; i<9; i++) {
                    if(b[i] === null) {
                        b[i] = 'X';
                        best = Math.min(best, minimax(b, depth+1, true, limit));
                        b[i] = null;
                    }
                }
                return best;
            }
        }

        // Helpers
        function getRandomMove() {
            let avail = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            return avail.length > 0 ? avail[Math.floor(Math.random() * avail.length)] : -1;
        }

        function checkWinStatic(b, p) {
            return winPatterns.some(pt => b[pt[0]] === p && b[pt[1]] === p && b[pt[2]] === p);
        }

        function checkWin(p) {
            const won = checkWinStatic(board, p);
            if(won) {
                // Highlight
                winPatterns.forEach(pt => {
                    if(board[pt[0]]===p && board[pt[1]]===p && board[pt[2]]===p) {
                        pt.forEach(i => cells[i].classList.add('win'));
                    }
                });
            }
            return won;
        }

        function checkDraw() { return !board.includes(null); }

        function endGame(playerWon) {
            isGameActive = false;
            
            if (playerWon === true) {
                document.getElementById('status-text').innerText = "VICTORY";
                const diff = document.getElementById('difficulty').value;
                const reward = diff === 'easy' ? 10 : (diff === 'medium' ? 25 : 50);
                
                User.coins += reward;
                User.stats.wins++;
                User.stats.streak++;
                
                UI.toast(`+${reward} COINS AWARDED`);
                checkAchievements();
            } else if (playerWon === false) {
                document.getElementById('status-text').innerText = "DEFEAT";
                User.stats.losses++;
                User.stats.streak = 0;
            } else {
                document.getElementById('status-text').innerText = "DRAW";
            }
            
            saveGameData();
        }

        function restartGame() { initGame(); }

        /**
         * ======================================
         * 4. PROFILE & SHOP
         * ======================================
         */
        const THEMES = [
            {id:'default', name:'Cyan', color:'#00f3ff', price:0},
            {id:'gold', name:'Gold', color:'#ffd700', price:100},
            {id:'red', name:'Crimson', color:'#ff0055', price:250}
        ];

        function openProfile() {
            document.getElementById('p-name').innerText = User.name;
            document.getElementById('p-id').innerText = User.id;
            document.getElementById('p-avatar').innerText = User.name.charAt(0);
            document.getElementById('p-wins').innerText = User.stats.wins;
            document.getElementById('p-losses').innerText = User.stats.losses;
            document.getElementById('p-streak').innerText = User.stats.streak;
            document.getElementById('p-coins').innerText = User.coins;
            
            // Badges
            const list = document.getElementById('p-achievements');
            list.innerHTML = '';
            // Example badges
            const badges = [
                {id:'first', label:'★', req: User.stats.wins > 0},
                {id:'pro', label:'♛', req: User.stats.wins > 10},
                {id:'rich', label:'$', req: User.coins > 500}
            ];
            badges.forEach(b => {
                const div = document.createElement('div');
                div.className = `ach-badge ${b.req ? 'unlocked' : ''}`;
                div.innerText = b.label;
                list.appendChild(div);
            });

            document.getElementById('profile-modal').classList.add('open');
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.remove('open');
        }

        function shareProfile() {
            const txt = `Agent ${User.name} | Wins: ${User.stats.wins} | Coins: ${User.coins} | Ace Horizon`;
            if (navigator.share) {
                navigator.share({ title: 'Ace Horizon Stats', text: txt });
            } else {
                navigator.clipboard.writeText(txt);
                UI.toast("Stats copied to clipboard");
            }
        }

        function checkAchievements() {
            if(User.stats.wins === 1 && !User.achievements.includes('first')) {
                User.achievements.push('first');
                UI.toast("Achievement Unlocked: First Blood");
            }
        }

        // Shop
        function toggleShop() {
            const m = document.getElementById('shop-modal');
            m.classList.toggle('open');
            if(m.classList.contains('open')) {
                const list = document.getElementById('shop-list');
                list.innerHTML = '';
                THEMES.forEach(t => {
                    const owned = User.inventory.includes(t.id);
                    const btnTxt = owned ? "EQUIP" : `${t.price}c`;
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div class="btn" style="border-color:${t.color}; color:${owned?'#fff':'#888'}" 
                             onclick="buyOrEquip('${t.id}', ${t.price})">
                             ${t.name} <br> ${btnTxt}
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function buyOrEquip(id, price) {
            if(User.inventory.includes(id)) {
                User.theme = id;
                saveGameData();
                UI.toast("Theme Equipped");
                toggleShop();
            } else {
                if(User.coins >= price) {
                    User.coins -= price;
                    User.inventory.push(id);
                    saveGameData();
                    UI.toast("Item Purchased");
                    toggleShop(); // close to refresh
                } else {
                    UI.toast("Insufficient Coins");
                }
            }
        }

        function getThemeColor(id) {
            const t = THEMES.find(x => x.id === id);
            return t ? t.color : '#00f3ff';
        }

        // --- INIT ---
        checkAuth();

    </script>
</body>
</html>
